---
AWSTemplateFormatVersion: "2010-09-09"
Description: Enderscraft Public VPC Stack
Metadata:
  License: CC BY-NC 4.0
  Author: Josh Enders <josh.enders@gmail.com>

Parameters:
  ParameterVPCCIDR:
    Description: "VPC CIDR Block"
    Type: String
    AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
    Default: "10.0.0.0/24"

  ParameterSubnetPublicCIDR:
    Description: "Public Subnet CIDR Block"
    Type: String
    AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
    Default: "10.0.0.0/26"

  ParameterAdminCIDR:
    Description: "CIDR Block which will be able to connect to RCON"
    Type: String
    AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
    Default: "0.0.0.0/0"

  ParameterMinecraftPort:
    Description: "Minecraft port"
    Type: String
    AllowedPattern: '\d{1,5}'
    Default: "25565"

  ParameterRCONPort:
    Description: "RCON port"
    Type: String
    AllowedPattern: '\d{1,5}'
    Default: "25575"

  ParameterHostedZone:
    Description: "Domain Name"
    Type: String
    AllowedPattern: "[a-zA-Z0-9-.]+"

  ParameterIAMUser:
    Description: "IAM User"
    Type: String
    AllowedPattern: "[a-z]+"
    Default: "enderscraft"

  ParameterLogRetentionDays:
    Description: "Days of log retention for tasks"
    Type: String
    AllowedPattern: '^(1|3|5|7|14|30|60|90|120|150|180|365|400|545|731|1827|3653)$'
    Default: "7"

  ParameterBudgetAmountUSD:
    Description: "Allowance of USD to spend per unit of time"
    Type: String
    AllowedPattern: '^\d+(\.\d+)?$'
    Default: "10"

  ParameterBudgetFrequency:
    Description: "Period of time to calculate budget (ex: DAILY|MONTHLY|QUARTERLY|ANNUALLY)"
    Type: String
    AllowedPattern: '^(ANNUALLY|DAILY|MONTHLY|QUARTERLY)$'
    Default: "MONTHLY"

  ParameterEmailAddress:
    Description: "Email address for budget notifications"
    Type: String
    AllowedPattern: '[a-zA-Z0-9-.+%]+@[a-zA-Z0-9-.]+'


Resources:
  # Budget
  Budget:
    Type: "AWS::Budgets::Budget"
    Properties:
      Budget:
        BudgetLimit:
          Amount: !Ref ParameterBudgetAmountUSD
          Unit: USD
        TimeUnit: !Ref ParameterBudgetFrequency
        BudgetType: COST
        CostFilters:
          TagKeyValue:
            - !Sub "aws:cloudformation:stack-name$${AWS::StackName}"
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: ACTUAL
            ComparisonOperator: GREATER_THAN
            Threshold: 95
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref ParameterEmailAddress

        - Notification:
            NotificationType: ACTUAL
            ComparisonOperator: GREATER_THAN
            Threshold: 50
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref ParameterEmailAddress


  # DNS
  HostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name:
        Ref: ParameterHostedZone


  # VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref ParameterVPCCIDR
      EnableDnsHostnames: true
      EnableDnsSupport: true
      InstanceTenancy: default
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-VPC


  # Network Gateways
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    DependsOn: VPC
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-InternetGateway

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway


  # Network ACL
  NetworkAclSubnetPublic:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-NetworkAclSubnetPublic


  # Public Subnet
  SubnetPublic:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref ParameterSubnetPublicCIDR
      AvailabilityZone: !Select [0, !GetAZs ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-SubnetPublic

  NetworkAclAssociationSubnetPublic:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId:
        Ref: SubnetPublic
      NetworkAclId:
        Ref: NetworkAclSubnetPublic

  RouteTableSubnetPublic:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-RouteTableSubnetPublic

  RouteSubnetPublicDefault:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref RouteTableSubnetPublic
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociationSubnetPublic:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref SubnetPublic
      RouteTableId: !Ref RouteTableSubnetPublic


  # Security Groups
  SecurityGroupFargateTasks:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref VPC
      GroupDescription: Security Group for Fargate Tasks
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          Description: !Sub "Allow inbound connections on port ${ParameterMinecraftPort}"
          FromPort: !Ref ParameterMinecraftPort
          IpProtocol: tcp
          ToPort: !Ref ParameterMinecraftPort

        - CidrIp: !Ref ParameterAdminCIDR
          Description: !Sub "Allow inbound connections on port ${ParameterRCONPort}"
          FromPort: !Ref ParameterRCONPort
          IpProtocol: tcp
          ToPort: !Ref ParameterRCONPort
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-SecurityGroupFargateTasks


  # IAM
  IAMUser:
    Type: AWS::IAM::User
    Properties:
      UserName: !Ref ParameterIAMUser

  IAMRoleECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      Description: "Role for executing ECS Tasks"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: sts:AssumeRole
          Principal:
            Service: ecs-tasks.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      RoleName: ecsTaskExecutionRole
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-IAMRoleECSTaskExecutionRole

  IAMRoleDDNSLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      Description: "Role for executing DDNS Lambdas"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: sts:AssumeRole
          Principal:
            Service: lambda.amazonaws.com
      RoleName: DDNSLambdaExecutionRole
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-DDNSLambdaExecutionRole

  IAMPolicyFargateCLI:
    Type: 'AWS::IAM::Policy'
    DependsOn: IAMUser
    Properties:
      PolicyName: FargateCLIPolicy
      Users: 
        - !Ref ParameterIAMUser
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "acm:ListCertificates"
              - "ec2:DescribeNetworkInterfaces"
              - "ecs:CreateCluster"
              - "ecs:DescribeTaskDefinition"
              - "ecs:ListServices"
              - "ecs:ListTasks"
              - "ecs:RegisterTaskDefinition"
              - "elasticloadbalancing:DescribeLoadBalancers"
            Resource: '*'

          - Effect: Allow
            Action:
              - "ecs:RunTask"
            Resource: !Sub "arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task-definition/*:*"

          - Effect: Allow
            Action:
              - elasticloadbalancing:DeleteLoadBalancer
            Resource: !Sub "arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:loadbalancer/net/*"

          - Effect: Allow
            Action:
              - "ecs:DescribeTasks"
              - "ecs:StopTask"
              - "iam:GetRole"
              - "iam:PassRole"
              - "logs:CreateLogGroup"
              - "logs:FilterLogEvents"
            Resource:
              - !Sub "arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task/fargate/*"
              - !Sub "arn:aws:iam::${AWS::AccountId}:role/ecsTaskExecutionRole"
              - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/fargate/*/*:*:"

          - Effect: Allow
            Action:
              - "ecs:CreateService"
              - "ecs:DeleteService"
              - "ecs:DescribeServices"
              - "ecs:UpdateService"
              - "sts:AssumeRole"
            Resource:
              - !Sub "arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:service/fargate/*"
              - !Sub "arn:aws:iam::${AWS::AccountId}:role/ecsTaskExecutionRole"


  IAMPolicyDDNSLambdaExecution:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: DDNSLambdaExecutionPolicy
      Roles:
        - !Ref IAMRoleDDNSLambdaExecutionRole
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:*
            Resource: "*"

          - Effect: Allow
            Action: ec2:Describe*
            Resource: "*"

          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Resource: "*"

          - Effect: Allow
            Action:
              - route53:*
            Resource:
              - "*"

          - Effect: Allow
            Action:
              - SNS:Publish
            Resource:
              - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:DDNSAlerts"


  # ECR
  ECRRepository:
    Type: AWS::ECR::Repository
    DependsOn: IAMRoleECSTaskExecutionRole
    Properties:
      RepositoryName: !Sub ${AWS::StackName}
      ImageScanningConfiguration:
        scanOnPush: true
      ImageTagMutability: "MUTABLE"
      LifecyclePolicy:
        LifecyclePolicyText: |-
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "Keep only one untagged image, expire all others",
                "selection": {
                  "tagStatus": "untagged",
                  "countType": "imageCountMoreThan",
                  "countNumber": 1
                },
                "action": {
                  "type": "expire"
                  }
                }
            ]
          }
      RepositoryPolicyText:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS:
                - !Sub "arn:aws:iam::${AWS::AccountId}:role/ecsTaskExecutionRole"
            Action:
              - "ecr:BatchCheckLayerAvailability"
              - "ecr:BatchGetImage"
              - "ecr:DescribeImages"
              - "ecr:DescribeRepositories"
              - "ecr:GetDownloadUrlForLayer"
              - "ecr:ListImages"
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-ECRRepository


  # LogGroup
  LogGroupFargateTask:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/fargate/task/${AWS::StackName}"
      RetentionInDays: !Ref ParameterLogRetentionDays

  LogGroupFargateService:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/fargate/service/${AWS::StackName}"
      RetentionInDays: !Ref ParameterLogRetentionDays

# Ouputs
Outputs:
  ns1:
    Value: !Select [0, !GetAtt HostedZone.NameServers]
  ns2:
    Value: !Select [1, !GetAtt HostedZone.NameServers]
  ns3:
    Value: !Select [2, !GetAtt HostedZone.NameServers]
  ns4:
    Value: !Select [3, !GetAtt HostedZone.NameServers]